---
title: "index"
output: html_document
---

```{r load libraries}

library(tidyverse)
library(readxl)
library(sf)
library(gridExtra)

options(digits=2)
options(scipen = 999)

```

# County by County Canvass Report

Texas Secretary of State publishes county by county election results at [results.texas-election.com](https://results.texas-election.com/races).


```{r load Texas Election Results 2024}

df <- read_excel("data/elections/CountybyCountyCanvassReport.xlsx")

prez2024 <- df %>%
  select(-`ELECTION DATE-NAME`) %>%
  filter(`OFFICE NAME` == "PRESIDENT/VICE-PRESIDENT")

```


```{r president results tidying}

# rename spaced variable names
lookup <- c(OFFICE = "OFFICE NAME",
            CANDIDATE = "CANDIDATE NAME",
            COUNTY = "COUNTY NAME",
            TOTAL_VOTES = "TOTAL VOTES PER OFFICE PER COUNTY")
prez2024 <- rename(prez2024, all_of(lookup)) 


# remove comma from any vote tallies
prez2024 <- prez2024 %>% 
  mutate(TOTAL_VOTES = as.numeric(gsub(",", "", TOTAL_VOTES)))

# pivot county totals wider
prez2024wider <- prez2024 %>%
  pivot_wider(
    id_cols = COUNTY,
    names_from = CANDIDATE,
    values_from = TOTAL_VOTES,
    values_fill = list(TOTAL_VOTES = 0)
    ) %>%
  mutate(TotalVOTES = rowSums(across(-COUNTY))) %>% # total by county votes
  mutate(VoteSHARE = round((TotalVOTES / sum(TotalVOTES)), 5))


```

```{r}

top15counties <- prez2024wider %>%
  arrange(desc(TotalVOTES)) %>%
  select(COUNTY, TotalVOTES, VoteSHARE) %>%
  slice_max(VoteSHARE, n = 15)

```

Fetched Texas County Boundaries from [Texas Department of Transportation](https://gis-txdot.opendata.arcgis.com/datasets/texas-county-boundaries/explore?location=28.324243%2C-96.928342%2C5.62)

This dataset was created by TxDOT for internal purposes. TxDOT is not the authority for county boundary data for the state. These features were digitized by TxDOT from georeferenced USGS topo maps to enable the classification of roadway attributes for the purposes of satisfying federal and state reporting requirements, and to serve as a base layer for TxDOT's cartographic products. 


```{r texas gis data}

# load county shapefiles
sf <- st_read("data/gis/counties/Texas_County_Boundaries_4845315375211121464/County_Boundaries.shp")

countyVoteShareSF <- sf %>%
  mutate(CNTY_NM = toupper(CNTY_NM)) %>%
  left_join(prez2024wider, join_by(CNTY_NM == COUNTY)) %>%
  rename(COUNTY = "CNTY_NM") %>%
  mutate(Top15 = ifelse(COUNTY %in% top15counties$COUNTY, "Top 15", "Other")) %>%
  select(GID, COUNTY, TotalVOTES, VoteSHARE, Top15, geometry)

```


```{r}

# county vote share
map0 <- ggplot(countyVoteShareSF) +
  geom_sf(aes(fill = VoteSHARE), color = "white", size = 0.2) +
  scale_fill_viridis_c(option = "plasma", name = "Vote Share (%)") +
  theme_minimal() +
  theme_void()

# map of top 15 counties by vote share
map1 <- ggplot(countyVoteShareSF) +
  geom_sf(aes(fill = Top15), color = "white", size = 0.2) +
  scale_fill_manual(values = c("Top 15" = "#AD2FFF", "Other" = "grey90")) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_sf(datum = NA)

# map of all other counties by vote share
map2 <- ggplot(countyVoteShareSF) +
  geom_sf(aes(fill = Top15), color = "white", size = 0.2) +
  scale_fill_manual(values = c("Top 15" = "grey90", "Other" = "#158100")) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_sf(datum = NA)

# arrange maps together
grid.arrange(map2, map1, ncol=2,
             top = "Electoral Distribution In Texas",
             bottom = "Source: Texas Secretary of State")

```


```{r historical election data}

# load 1964 Texas presidential election data
election1964 <- read_csv("data/elections/County_Presidential_Election_Data_1964_0_0_2.csv") 

# select key variables
election1964 <- election1964 %>%
  filter(grepl("^48", FIPS)) %>%                 
  mutate(COUNTY = toupper(`Geographic Name`)) %>%
  select(FIPS, COUNTY, `Total Vote`, `Lyndon Johnson`, `Barry Goldwater`) 

# rename with party distinctions
election1964 <- election1964 %>%
  rename(c(DEMOCRATIC_1964 = `Lyndon Johnson`, REPUBLICAN_1964 = `Barry Goldwater`, TotalVOTES_1964 = `Total Vote`))
  
# prep for join with current election data, including changing data to doubles
election1964 <- election1964 %>%
  mutate(TotalVOTES_1964 = as.numeric(TotalVOTES_1964),
         DEMOCRATIC_1964 = as.numeric(DEMOCRATIC_1964),
         REPUBLICAN_1964 = as.numeric(REPUBLICAN_1964)) %>%
  mutate(VoteSHARE_1964 = round((TotalVOTES_1964 / sum(TotalVOTES_1964)), 5))

# rename 2024 election data with party distinctions
election2024 <- prez2024wider %>%
  select(COUNTY, TotalVOTES, `KAMALA D. HARRIS/TIM WALZ`, `DONALD J. TRUMP/JD VANCE`, VoteSHARE) %>%
  rename(c(TotalVOTES_2024 = TotalVOTES, DEMOCRATIC_2024 = `KAMALA D. HARRIS/TIM WALZ`, 
           REPUBLICAN_2024 = `DONALD J. TRUMP/JD VANCE`, VoteSHARE_2024 = VoteSHARE))

# join 1964 and 2024 voter data
electionDiff <- election1964 %>%
  left_join(election2024, join_by(COUNTY))

# pull county GIS data and join with voter data
electionDiffSF <- countyVoteShareSF %>%
  select(COUNTY, geometry, Top15) %>%
  left_join(electionDiff, join_by(COUNTY))

```

```{r}

# extract centroid coordinates
county_centroids <- st_centroid(electionDiffSF) %>%
  mutate(lon = st_coordinates(geometry)[,1],
         lat = st_coordinates(geometry)[,2])

# plot total (nominal) vote difference
ggplot() +
  # base map
  geom_sf(data = electionDiffSF, fill = "grey90", color = "grey50", size = 0.2) +
  geom_sf(data = electionDiffSF, aes(fill = Top15)) +
  scale_fill_manual(values = c("Top 15" = "#AD2FFF", "Other" = "grey90")) +
  # 1964 bubbles (solid circles)
  geom_point(data = county_centroids,
             aes(x = lon, y = lat, size = TotalVOTES_1964),
             shape = 16, color = "black", stroke = 1, alpha = 0.5) +
  # 2024 bubbles (rings)
  geom_point(data = county_centroids,
             aes(x = lon, y = lat, size = TotalVOTES_2024, stroke = .5),
             shape = 1, color = "black", alpha = 0.6) +
  # shared size scale
  scale_size(range = c(0.4, 9), 
             breaks = c(10000, 100000, 1000000), 
             labels = c("10k", "100k", "1m"),
             name = "TOTAL VOTES CAST") +
  coord_sf(datum = NA) + # remove gridlines
  theme_minimal() +
  theme(legend.position = "right")

# plot total (vote share) difference
ggplot() +
  # base map
  geom_sf(data = electionDiffSF, fill = "grey90", color = "grey50", size = 0.2) +
  geom_sf(data = electionDiffSF, aes(fill = Top15)) +
  scale_fill_manual(values = c("Top 15" = "#AD2FFF", "Other" = "grey90")) +
  # 1964 bubbles (solid circles)
  geom_point(data = county_centroids,
             aes(x = lon, y = lat, size = VoteSHARE_1964),
             shape = 16, color = "black", stroke = 1, alpha = 0.5) +
  # 2024 bubbles (rings)
  geom_point(data = county_centroids,
             aes(x = lon, y = lat, size = VoteSHARE_2024, stroke = .5),
             shape = 1, color = "black", alpha = 0.6) +
  # shared size scale
  scale_size(range = c(0.4, 9), 
             breaks = c(0.005, 0.01, 0.05, 0.10), 
             labels = c("0.05%", "1%", "5%", "10%"),
             name = "TOTAL VOTES CAST") +
  coord_sf(datum = NA) +
  theme_minimal() +
  theme(legend.position = "right")

```


