---
title: "index"
output: html_document
---

```{r load libraries}

library(tidyverse)
library(readxl)
library(sf)
library(gridExtra)

options(digits=2)
options(scipen = 999)

```

# County by County Canvass Report

Texas Secretary of State publishes county by county election results at [results.texas-election.com](https://results.texas-election.com/races).


```{r load Texas Election Results 2024}

df <- read_excel("data/elections/CountybyCountyCanvassReport.xlsx")

prez2024 <- df %>%
  select(-`ELECTION DATE-NAME`) %>%
  filter(`OFFICE NAME` == "PRESIDENT/VICE-PRESIDENT")

```


```{r president results tidying}

# rename spaced variable names
lookup <- c(OFFICE = "OFFICE NAME",
            CANDIDATE = "CANDIDATE NAME",
            COUNTY = "COUNTY NAME",
            TOTAL_VOTES = "TOTAL VOTES PER OFFICE PER COUNTY")
prez2024 <- rename(prez2024, all_of(lookup)) 


# remove comma from any vote tallies
prez2024 <- prez2024 %>% 
  mutate(TOTAL_VOTES = as.numeric(gsub(",", "", TOTAL_VOTES)))

# pivot county totals wider
prez2024wider <- prez2024 %>%
  pivot_wider(
    id_cols = COUNTY,
    names_from = CANDIDATE,
    values_from = TOTAL_VOTES,
    values_fill = list(TOTAL_VOTES = 0)
    ) %>%
  mutate(TotalVOTES = rowSums(across(-COUNTY))) %>% # total by county votes
  mutate(VoteSHARE = round((TotalVOTES / sum(TotalVOTES)), 5))


```

```{r}

top15counties <- prez2024wider %>%
  arrange(desc(TotalVOTES)) %>%
  select(COUNTY, TotalVOTES, VoteSHARE) %>%
  slice_max(VoteSHARE, n = 15)

```

Fetched Texas County Boundaries from [Texas Department of Transportation](https://gis-txdot.opendata.arcgis.com/datasets/texas-county-boundaries/explore?location=28.324243%2C-96.928342%2C5.62)

This dataset was created by TxDOT for internal purposes. TxDOT is not the authority for county boundary data for the state. These features were digitized by TxDOT from georeferenced USGS topo maps to enable the classification of roadway attributes for the purposes of satisfying federal and state reporting requirements, and to serve as a base layer for TxDOT's cartographic products. 


```{r texas gis data}

# load county shapefiles
sf <- st_read("data/gis/counties/Texas_County_Boundaries_4845315375211121464/County_Boundaries.shp")

countyVoteShareSF <- sf %>%
  mutate(CNTY_NM = toupper(CNTY_NM)) %>%
  left_join(prez2024wider, join_by(CNTY_NM == COUNTY)) %>%
  rename(COUNTY = "CNTY_NM") %>%
  mutate(Top15 = ifelse(COUNTY %in% top15counties$COUNTY, "Top 15", "Other")) %>%
  select(GID, COUNTY, TotalVOTES, VoteSHARE, Top15, geometry)

```


```{r}

# county vote share
ggplot(countyVoteShareSF) +
  geom_sf(aes(fill = VoteSHARE), color = "white", size = 0.2) +
  scale_fill_viridis_c(option = "plasma", name = "Vote Share (%)") +
  theme_minimal()

# map of top 15 counties by vote share
map1 <- ggplot(countyVoteShareSF) +
  geom_sf(aes(fill = Top15), color = "white", size = 0.2) +
  coord_sf(datum = NA) + # remove grid lines
  scale_fill_manual(values = c("Top 15" = "#AD2FFF", "Other" = "grey90")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# map of all other counties by vote share
map2 <- ggplot(countyVoteShareSF) +
  geom_sf(aes(fill = Top15), color = "white", size = 0.2) +
  coord_sf(datum = NA) +
  scale_fill_manual(values = c("Top 15" = "grey90", "Other" = "#158100")) +
  theme_minimal() +
  theme(legend.position = "bottom")

# arrange maps together
grid.arrange(map2, map1, ncol=2,
             top = "Electoral Distribution In Texas",
             bottom = "Source: Texas Secretary of State")

```


```



